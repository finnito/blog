{{ partial "header.html" . }}

<div class="content">
    <h1>{{ .Title | markdownify }}</h1>
    <p><strong>Activity Date:</strong> {{ with .Params.date }}<time>{{ time.Format "2 Jan 2006" . }}</time>{{ end }}
    {{ with .GitInfo }}<br/><strong>Updated:</strong> <time>{{ .AuthorDate.Format "2 Jan 2006" }}</time>{{ end }}

    {{ with .Params.people }}
    <br/><strong>People:</strong> {{ range $index, $person := . }}
    <a href="/people#{{ anchorize $person }}" title="View trips with {{ $person }}.">
        {{ $person -}}
    </a>{{- if lt $index (sub (len $.Params.people) 1)}}, {{ end -}}{{ end }}
    {{ end }}
    </p>

    {{ if ne .Params.statsTable false }}
    {{ partial "statsTable.html" . }}
    {{ end }}

    {{ .Content }}

    <button class="load-comments" data-title="{{ .Title }}" data-isso-id="{{ .Slug }}" onclick="loadComments();">Load Comments</button>
</div>

<script>
    // var GPXFiles = [
    //     {{ range sort (.Resources.Match "*.gpx") }}
    //         "{{ .Permalink }}",
    //     {{ end }}
    //     ],

        GPXFiles = [
        {{ range .Params.gpxFiles }}
            "https://assets.lesueur.nz/blog/{{$.Page.Slug}}/{{ . }}",
        {{ end }}
        ],

        // GPXDataFiles = [
        // {{ range sort (.Resources.Match "*.gpx") }}
        //     "{{ $.Site.BaseURL }}/tracks/{{ index (split .Title ".") 0 }}.json",
        // {{ end }}
        // ],

        GPXDataFiles = [
        {{ range .Params.gpxFiles }}
            "{{ $.Site.BaseURL }}tracks/{{ strings.Replace . "gpx" "json" }}",
        {{ end }}
        ];

    window.addEventListener("DOMContentLoaded", function() {
        document.getElementById("hikeMap").addEventListener("click", mapClick);
    });

    function mapClick() {
        document.getElementById("hikeMap").removeEventListener("click", mapClick);

        function loadResource(url, type) {
            return new Promise(function(resolve, reject) {
                let resource;
                if (type == "css") {
                    resource = document.createElement("link");
                    resource.setAttribute("rel", "stylesheet");
                    resource.href = url;
                } else {
                    resource =document.createElement("script");
                    resource.src = url;
                    resource.async = false;
                }
                resource.onload = function() {
                    resolve(url);
                }
                resource.onerror = function() {
                    reject(url);
                }
                document.head.appendChild(resource);
            });
        }

        var styles = ["/css/leaflet.min.css", "/css/leaflet-fullscreen.min.css"];
        var stylePromises = [];
        styles.forEach(function(href) {
            stylePromises.push(loadResource(href, "css"));
        });

        function loadScripts() {
            var scripts = [
                "/js/leaflet.min.js",
                "/js/Polyline.encoded.js",
                "/js/Leaflet.fullscreen.min.js",
                "/js/multiHike.js"]
            var scriptPromises = [];
            scripts.forEach(function(src) {
                scriptPromises.push(loadResource(src, "js"));
            });

            Promise.all(scriptPromises)
            .then(function() {
                initHike();
                document.querySelector("button.load-map").remove();
            })
            .catch(function(script) {
                console.log("Error loading: " + script);
            })
        }

        Promise.all(stylePromises)
        .then(function() {
            loadScripts();            
        })
        .catch(function(style) {
            console.log("Error loading: " + style);
        })
    }
</script>
<script src="/js/minimasonry.min.js" async></script>
<script src="/js/glightbox.min.js" async></script>
<link rel="stylesheet" href="/css/glightbox.min.css"/>
<script>
    window.addEventListener("load", function() {
        
        // https://github.com/Spope/MiniMasonry.js/
        console.log("Init Masonry");
        var grids = document.querySelectorAll('.grid');
        grids.forEach(function(grid) {
            var masonry = new MiniMasonry({
                container: grid,
                baseWidth: 400,
                gutterX: 5,
                gutterY: 0
            });
        });

        // https://github.com/biati-digital/glightbox
        const lightbox = GLightbox({
            touchNavigation: true,
            openEffect: 'fade',
            closeEffect: 'fade',
            slideEffect: 'fade',
            descPosition: 'right',
            loop: false
        });
        
    });
</script>
{{ partial "isso-script.html" . }}

{{ partial "footer.html" . }}
